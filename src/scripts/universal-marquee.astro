---
// Komponen Astro
// Semua CSS dan JavaScript yang Anda buat sebelumnya diletakkan di sini.

const ITEMS_DEMO_1 = ['Web Design', 'App Development', 'SEO Audit', 'Cloud Server', 'Consulting'];
const SEPARATOR_DEMO_1 = {
  type: 'image',
  src: 'https://www.mdpabel.com/md-pabel.png',
  alt: 'Logo MDPabel',
};
const ITEMS_DEMO_2 = ['LOREM IPSUM', 'DOLOR SIT AMET', 'CONSECTETUR ADIPISCING', 'ELIT SED DO'];
const GALLERY_ITEMS = [
  { src: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&q=80', alt: 'Red Shoe' },
  { src: 'https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?w=400&q=80', alt: 'White Sneaker' },
  { src: 'https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=400&q=80', alt: 'Green Shoe' },
];

// Catatan: Root Layout Structure & Body Styling (RootLayout)
// Sebaiknya dipindahkan ke file layout Astro utama Anda atau dibiarkan di sini
// jika komponen ini adalah file halaman (page). Saya biarkan di sini
// agar style demo tetap utuh.
---

<style is:global>
  :root {
    --um-duration-default: 15s;
    --um-gap-default: 2rem;
    --um-color-separator: #9ca3af;
    --um-separator-height: 1.25em;
  }
  .um-container {
    display: flex;
    overflow: hidden;
    user-select: none;
    width: 100%;
    min-width: 0;
    position: relative;
    transform: translate3d(0, 0, 0);
  }
  .um-sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border-width: 0;
  }
  /* Track Logic */
  .um-container .um-track {
    display: none;
  }
  .um-container.js-enabled .um-track {
    display: flex;
  }
  .um-track {
    align-items: center;
    flex-wrap: nowrap;
    gap: var(--um-gap);
    will-change: transform;
    backface-visibility: hidden;
    perspective: 1000px;
  }
  .um-track > div {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    flex-shrink: 0;
    gap: var(--um-gap);
  }
  .um-track > div > * {
    flex-shrink: 0;
    white-space: nowrap;
    display: flex;
    align-items: center;
    width: auto;
    object-fit: contain;
  }

  /* Skeleton & Image Handling */
  .um-img-skeleton {
    position: relative;
    background-color: #e5e7eb;
    overflow: hidden;
    border-radius: 4px;
    transition: background-color 0.3s;
  }
  .um-img-skeleton img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    opacity: 0;
    transition: opacity 0.5s ease-out;
  }
  .um-img-skeleton img.loaded {
    opacity: 1;
  }

  /* Monokrom (Grayscale) & Mode-Specific Support */
  .um-img-skeleton.um-img-filter-active img,
  .um-img-skeleton.um-img-filter-active img.loaded {
    filter: var(--um-custom-filter, none) !important;
    transition: filter 0.5s ease-out;
  }

  /* Separator Specifics */
  .um-item-separator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .um-item-separator .um-img-skeleton {
    display: inline-block;
    height: var(--um-separator-height);
    width: auto;
    min-width: var(--um-separator-height);
    aspect-ratio: 1/1;
    background-color: transparent;
  }

  /* --- ROOT_LAYOUT STYLES (Dibiarkan untuk demo) --- */
  :root {
    --color-bg-page: #f9fafb;
    --color-text-primary: #111827;
    --color-guide-border: #ef4444;
    --layout-guide-width: 1px;
    --layout-guide-style: dashed;
    --layout-max-width: 1100px;
    --layout-vertical-padding: 3rem;
    --layout-footer-height: 3rem;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex;
    background-color: var(--color-bg-page);
    color: var(--color-text-primary);
  }
  .RootLayout {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 0;
  }
  /* ... (CSS RootLayout lainnya) ... */
  .RootLayout::before,
  .RootLayout::after {
    content: '';
    border-top: var(--layout-guide-width) var(--layout-guide-style) var(--color-guide-border);
    height: 0;
    position: absolute;
    left: 0;
    right: 0;
    z-index: 1;
    opacity: 0.4;
  }
  .RootLayout::before {
    top: var(--layout-vertical-padding);
  }
  .RootLayout::after {
    bottom: var(--layout-vertical-padding);
    border-bottom: var(--layout-guide-width) var(--layout-guide-style) var(--color-guide-border);
    border-top: none;
  }
  .RootLayoutContainer {
    width: 100%;
    max-width: var(--layout-max-width);
    min-height: calc(100dvh - var(--layout-footer-height) - var(--layout-vertical-padding));
    position: relative;
    padding-top: var(--layout-vertical-padding);
    padding-bottom: var(--layout-footer-height);
    border-left: var(--layout-guide-width) var(--layout-guide-style) var(--color-guide-border);
    border-right: var(--layout-guide-width) var(--layout-guide-style) var(--color-guide-border);
  }
  .RootLayoutContent {
    display: flex;
    flex-direction: column;
    padding: 2rem;
    gap: 3rem;
  }
  .RootLayoutFooter {
    width: 100%;
    height: var(--layout-footer-height);
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    color: #6b7280;
    border-top: 1px dashed rgba(239, 68, 68, 0.3);
  }
  h2.demo-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    color: #374151;
  }
  p.demo-desc {
    text-align: center;
    margin: 0 0 1rem 0;
    font-size: 0.85rem;
    color: #9ca3af;
  }
</style>

<div class="RootLayout">
  <div class="RootLayoutContainer">
    <div class="RootLayoutContent">
      <div>
        <h2 class="demo-title">Area 1: Services & Branding</h2>
        <p class="demo-desc">Gap: 6rem | Speed: Slow | Separator: MD Pabel Logo</p>
        <div
          id="marquee-demo-1"
          style="
                        background: #fff;
                        border: 1px solid #eee;
                        border-radius: 6px;
                        padding: 1rem 0;
                        --um-font-size: 1.5rem;
                        --um-gap: 6rem;
                        --um-separator-height: 24px;
                    "
        >
          <noscript>Javascript Required.</noscript>
        </div>
      </div>

      <div>
        <h2 class="demo-title">Area 2: News Ticker</h2>
        <p class="demo-desc">Gap: 2rem | Speed: Fast | Dark Theme</p>
        <div
          id="marquee-demo-2"
          style="background: #111827; color: white; padding: 0.8rem 0; --um-font-size: 1rem; --um-gap: 2rem"
        >
        </div>
      </div>

      <div>
        <h2 class="demo-title">Area 3: Full Lazy Loading Gallery (Monochrome Dark Mode)</h2>
        <p class="demo-desc">Items & Separators are Images with Skeleton Loaders</p>
        <div id="marquee-full-lazy" style="--um-gap: 3rem; --um-separator-height: 40px"></div>
      </div>
    </div>

    <div class="RootLayoutFooter">
      <span>Universal Marquee Demo &copy; 2025 – RootLayout Edition</span>
    </div>
  </div>
</div>

<script is:inline>
  // --- CLASS DEFINITIONS ---

  class ContentBuilder {
    _opts;
    constructor(options) {
      this._opts = options;
    }

    #buildSeparatorNode(separator) {
      const sepContainer = document.createElement('span');
      sepContainer.classList.add('um-item-separator');
      sepContainer.setAttribute('aria-hidden', 'true');

      if (typeof separator === 'string') {
        sepContainer.textContent = separator;
      } else if (separator instanceof Node) {
        sepContainer.appendChild(separator.cloneNode(true));
      } else if (typeof separator === 'object' && separator?.type === 'image') {
        const wrapper = document.createElement('div');
        wrapper.className = 'um-img-skeleton';

        // LOGIKA FILTER BARU UNTUK SEPARATOR IMAGE
        if (this._opts.monochrome) {
          const filterValue = this._opts.mode === 'dark' ? this._opts.darkFilter : this._opts.lightFilter;
          wrapper.style.setProperty('--um-custom-filter', filterValue);
          wrapper.classList.add('um-img-filter-active');
        }
        // END LOGIKA FILTER BARU

        const img = document.createElement('img');
        img.src = separator.src;
        img.alt = separator.alt || '';
        img.loading = 'lazy';

        const handleLoad = () => img.classList.add('loaded');
        img.onload = handleLoad;
        if (img.complete) handleLoad();

        wrapper.appendChild(img);
        sepContainer.appendChild(wrapper);
      }
      return sepContainer;
    }

    buildCycleContent(forSR = false) {
      const frag = document.createDocumentFragment();
      const items = this._opts.items;
      if (!items || items.length === 0) return frag;

      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (forSR) {
          const li = document.createElement('li');
          li.textContent = item.alt || item;
          frag.appendChild(li);
        } else {
          let node = this._opts.renderItem(item);
          if (!(node instanceof Element)) {
            const w = document.createElement('span');
            w.appendChild(node);
            node = w;
          }
          const cloned = node.cloneNode(true);

          // LOGIKA FILTER BARU UNTUK ITEM IMAGE
          const imgWrapper = cloned.classList.contains('um-img-skeleton')
            ? cloned
            : cloned.querySelector('.um-img-skeleton');
          if (imgWrapper && this._opts.monochrome) {
            const filterValue = this._opts.mode === 'dark' ? this._opts.darkFilter : this._opts.lightFilter;
            imgWrapper.style.setProperty('--um-custom-filter', filterValue);
            imgWrapper.classList.add('um-img-filter-active');
          }
          // END LOGIKA FILTER BARU

          const img = cloned.querySelector('img');
          if (img) {
            if (img.complete) img.classList.add('loaded');
            else img.onload = () => img.classList.add('loaded');
          }
          if (cloned.id) cloned.removeAttribute('id');
          cloned.querySelectorAll('*').forEach((el) => {
            if (el.id) el.removeAttribute('id');
            el.setAttribute('tabindex', '-1');
          });

          frag.appendChild(cloned);
          const sep = this.#buildSeparatorNode(this._opts.separator);
          if (sep) frag.appendChild(sep);
        }
      }
      return frag;
    }
    buildCycleContainer() {
      const c = document.createElement('div');
      c.appendChild(this.buildCycleContent(false));
      return c;
    }
    buildSRList() {
      const ul = document.createElement('ul');
      ul.className = 'um-sr-only';
      ul.appendChild(this.buildCycleContent(true));
      return ul;
    }

    measureCycleMetrics(root, track) {
      if (!this._opts.items || this._opts.items.length === 0) return { width: 0, gap: 0 };

      const temp = document.createElement('div');
      temp.className = 'um-track';
      Object.assign(temp.style, { position: 'absolute', visibility: 'hidden' });

      let gapVal = this._opts.gap;
      if (typeof gapVal === 'number') gapVal = `${gapVal}px`;
      temp.style.setProperty('--um-gap', gapVal);

      const cycle = this.buildCycleContainer();
      temp.appendChild(cycle);
      root.appendChild(temp);

      const width = cycle.offsetWidth || 0;
      const style = getComputedStyle(temp);

      let parsedGap = parseFloat(style.columnGap || style.gap || '0');
      if (isNaN(parsedGap)) parsedGap = 0;

      root.removeChild(temp);
      return { width, gap: parsedGap };
    }
  }

  class AnimationController {
    _track;
    _opts;
    _anim = null;
    constructor(track, opts) {
      this._track = track;
      this._opts = opts;
    }

    start(width, gap) {
      if (this._anim) this._anim.cancel();

      const safeWidth = Number.isFinite(width) ? width : 0;
      const safeGap = Number.isFinite(gap) ? gap : 0;
      const safeSpeed = this._opts.speed && this._opts.speed > 0 ? this._opts.speed : 50;

      const dist = safeWidth + safeGap;
      if (dist <= 0) return;

      const duration = (dist / safeSpeed) * 1000;

      let from = 'translate3d(0,0,0)';
      let to = `translate3d(-${dist}px,0,0)`;

      if (this._opts.direction === 'right') {
        from = `translate3d(-${dist}px,0,0)`;
        to = 'translate3d(0,0,0)';
      }

      this._anim = this._track.animate([{ transform: from }, { transform: to }], {
        duration,
        iterations: Infinity,
        easing: 'linear',
      });
    }
  }

  class UniversalMarquee {
    constructor(selector, opts) {
      this._root = document.querySelector(selector);
      if (!this._root) return;
      this._opts = {
        speed: 50,
        gap: '2rem',
        direction: 'left',
        items: [],
        separator: '',
        renderItem: (i) => document.createTextNode(i),
        // OPSI BARU
        monochrome: false,
        mode: 'light',
        lightFilter: 'grayscale(100%)',
        darkFilter: 'grayscale(100%) brightness(0.6) invert(1) hue-rotate(180deg)',
        // ---------------
        ...opts,
      };
      this._root.classList.add('um-container', 'js-enabled');
      this._builder = new ContentBuilder(this._opts);
      this.#setup();
      // Perlu menggunakan window.ResizeObserver atau menempatkan di file .js terpisah
      // agar tidak ada error di browser lama jika menggunakan is:inline.
      new ResizeObserver(() => requestAnimationFrame(this.#reflow.bind(this))).observe(this._root);
    }
    #setup() {
      this._root.innerHTML = '';
      this._track = document.createElement('div');
      this._track.className = 'um-track';
      this._track.setAttribute('aria-hidden', 'true');
      this._root.appendChild(this._builder.buildSRList());
      this._root.appendChild(this._track);
      this.#reflow();
    }
    #reflow() {
      const m = this._builder.measureCycleMetrics(this._root, this._track);
      if (m.width === 0) return;
      const cycles = Math.ceil(this._root.offsetWidth / (m.width + m.gap)) + 2;
      this._track.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (let i = 0; i < Math.max(3, cycles); i++) frag.appendChild(this._builder.buildCycleContainer());
      this._track.appendChild(frag);
      if (!this._anim) this._anim = new AnimationController(this._track, this._opts);
      this._anim.start(m.width, m.gap);
    }
  }
  window.UniversalMarquee = UniversalMarquee;

  // --- INSTANTIATION LOGIC ---
  const initApp = () => {
    // Data diambil dari frontmatter Astro (di atas ---)
    const ITEMS_DEMO_1 = ['Web Design', 'App Development', 'SEO Audit', 'Cloud Server', 'Consulting'];
    const SEPARATOR_DEMO_1 = { type: 'image', src: 'https://www.mdpabel.com/md-pabel.png', alt: 'Logo MDPabel' };
    const ITEMS_DEMO_2 = ['LOREM IPSUM', 'DOLOR SIT AMET', 'CONSECTETUR ADIPISCING', 'ELIT SED DO'];
    const GALLERY_ITEMS = [
      { src: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&q=80', alt: 'Red Shoe' },
      { src: 'https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?w=400&q=80', alt: 'White Sneaker' },
      { src: 'https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=400&q=80', alt: 'Green Shoe' },
    ];

    // RENDERERS
    const textRenderer = (txt) => {
      const s = document.createElement('span');
      s.textContent = txt;
      s.style.fontWeight = '600';
      return s;
    };
    const imageRenderer = (item) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'um-img-skeleton';
      wrapper.style.width = '140px';
      wrapper.style.height = '90px';

      const img = document.createElement('img');
      img.src = item.src;
      img.alt = item.alt;
      img.loading = 'lazy';

      wrapper.appendChild(img);
      return wrapper;
    };

    // INSTANCES

    // 1. Demo Logo Pribadi (Light Mode Default)
    new window.UniversalMarquee('#marquee-demo-1', {
      speed: 60,
      gap: '6rem',
      items: ITEMS_DEMO_1,
      separator: SEPARATOR_DEMO_1,
      renderItem: textRenderer,
    });

    // 2. Demo News Ticker
    new window.UniversalMarquee('#marquee-demo-2', {
      speed: 100,
      gap: '2rem',
      direction: 'right',
      items: ITEMS_DEMO_2,
      separator: ' • ',
      renderItem: (t) => {
        const s = document.createElement('span');
        s.textContent = t;
        s.style.color = '#e5e7eb';
        return s;
      },
    });

    // 3. Full Lazy Gallery (Monochrome Dark Mode)
    new window.UniversalMarquee('#marquee-full-lazy', {
      speed: 50,
      gap: '3rem',
      items: GALLERY_ITEMS,
      separator: {
        type: 'image',
        src: 'https://cdn-icons-png.flaticon.com/512/766/766029.png',
        alt: '',
      },
      monochrome: true, // AKTIF!
      mode: 'dark', // PENGATURAN MODE
      renderItem: imageRenderer,
    });
  };

  // Panggil initApp saat DOM siap
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
</script>
